---
import { type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import Layout from "./main.astro";
import FormattedDate from "@/components/ui/formatted-date.astro";
import TableOfContents from "@/components/post/toc.astro";
import RelatedPosts from "@/components/post/related-posts.astro";

type Props = {
  post: CollectionEntry<"post">;
  headings: import("astro").MarkdownHeading[];
};

const { post, headings } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  tags,
  categories,
} = post.data;
---

<Layout title={title} description={description}>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
    slot="reject-head"
  />
  <!-- Main Content -->
  <main
    class="relative z-30 max-w-5xl pb-1 mx-auto mt-10 bg-white dark:bg-neutral-950 md:rounded-t-md text-neutral-900"
  >
    <!-- Header Section -->
    <header
      class="px-5 pt-6 md:pt-20 border-t border-neutral-200 dark:border-neutral-800 md:border-x md:rounded-t-2xl"
    >
      <h1
        class="max-w-4xl mx-auto text-3xl font-bold tracking-tight md:text-4xl lg:text-5xl dark:text-neutral-100"
      >
        {title}
      </h1>
      <div
        class="flex flex-wrap justify-between items-center max-w-4xl mx-auto mt-4 text-sm text-neutral-600 dark:text-neutral-400"
      >
        <div class="flex items-center gap-2">
          <FormattedDate date={pubDate} />
          {
            updatedDate && (
              <span class="ml-4 text-xs">
                更新于 <FormattedDate date={updatedDate} />
              </span>
            )
          }
        </div>
        {
          tags && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <span class="px-2 py-1 rounded-full bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 text-xs">
                  {tag}
                </span>
              ))}
            </div>
          )
        }
      </div>
    </header>
    <!-- Hero Image Section -->
    {
      heroImage && (
        <div class="max-w-4xl mx-auto mt-8 px-5 lg:px-0">
          <Image
            width={1020}
            height={510}
            src={heroImage}
            alt={title || "Hero Image"}
            class="rounded-lg shadow-sm"
          />
        </div>
      )
    }
    <div class="relative z-30 mx-auto flex mt-12">
      <div>
        <!-- Article Section -->
        <article
          class="prose prose-sm lg:prose-lg dark:prose-invert w-full max-w-4xl mx-auto mb-20 px-7 lg:px-0"
        >
          <slot />
        </article>
        <!-- Categories and Related Posts Section -->
        <footer
          class="max-w-4xl mx-auto px-5 lg:px-0 mt-16 pb-10 border-t border-neutral-200 dark:border-neutral-800"
        >
          {
            categories && (
              <div class="text-sm text-neutral-600 dark:text-neutral-400 mb-4">
                分类于：
                {categories.map((cat) => (
                  <span class="mr-2 px-2 py-1 bg-neutral-100 dark:bg-neutral-800 rounded-md">
                    {cat}
                  </span>
                ))}
              </div>
            )
          }
          <RelatedPosts currentPost={post} />
        </footer>
      </div>
      <!-- Table of Contents Section (Sticky Right Sidebar) -->
      <aside
        class="hidden lg:block w-64 ml-8 sticky top-24 h-[calc(100vh-6rem)] overflow-y-auto"
      >
        <TableOfContents headings={headings} levels={3} />
      </aside>
    </div>
  </main>
</Layout>
