---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  levels?: 1 | 2 | 3 | 4 | 5;
}

const { headings, levels = 3 } = Astro.props as Props;
const filteredHeadings = headings.filter((heading) => heading.depth <= levels);
---

<div
  class="border rounded-2xl p-5 text-sm bg-white dark:bg-neutral-900 shadow-sm"
>
  <h4 class="text-lg font-semibold border-b pb-2 mb-4">Table of Contents</h4>
  <ul class="flex flex-col gap-2">
    {
      filteredHeadings.map((heading) => (
        <li
          class:list={{
            "pl-2": heading.depth === 2,
            "pl-5": heading.depth === 3,
            "pl-8": heading.depth === 4,
            "pl-11": heading.depth === 5,
          }}
        >
          <a
            href={`#${heading.slug}`}
            class="toc-link transition duration-150 hover:text-blue-600 dark:hover:text-blue-400"
          >
            {heading.text}
          </a>
        </li>
      ))
    }
  </ul>
</div>

<style lang="scss">
  .toc-link {
    @apply text-neutral-700 dark:text-neutral-300;
  }

  .toc-current {
    @apply text-blue-600 dark:text-blue-400 font-medium;
  }
</style>

<script>
  let observeHeaderTags;
  let allHeaderTags;

  function setCurrent(entries) {
    const allLinks = document.querySelectorAll(".toc-link");
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        allLinks.forEach((link) => link.classList.remove("toc-current"));
        const activeLink = document.querySelector(
          `a[href="#${entry.target.id}"]`
        );
        if (activeLink) activeLink.classList.add("toc-current");
      }
    });
  }

  function initTOC() {
    const content = document.querySelector(".markdown-content");
    if (!content) return;

    allHeaderTags = content.querySelectorAll(
      ":scope > h1, :scope > h2, :scope > h3"
    );

    const options = {
      root: null,
      rootMargin: "0px 0px -60% 0px",
      threshold: [1],
    };

    observeHeaderTags = new IntersectionObserver(setCurrent, options);

    allHeaderTags.forEach((tag) => {
      tag.classList.add("scroll-mt-24");
      observeHeaderTags.observe(tag);
    });
  }

  initTOC();
  document.addEventListener("astro:after-swap", initTOC);
</script>
